<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Dashboard ‚Äî Biojos</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{min-height:100vh;background:linear-gradient(135deg,#0f0c29,#302b63);font-family:'Segoe UI',sans-serif;color:#fff;padding-bottom:40px}
    nav{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:rgba(255,255,255,.05);border-bottom:1px solid rgba(255,255,255,.1);backdrop-filter:blur(8px);position:sticky;top:0;z-index:50}
    .logo{font-size:1.3rem;font-weight:800;background:linear-gradient(90deg,#a78bfa,#818cf8);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .nav-right{display:flex;align-items:center;gap:12px}
    .nav-user{font-size:.85rem;color:rgba(255,255,255,.6)}
    .btn-logout{padding:7px 16px;border:1px solid rgba(239,68,68,.4);border-radius:8px;color:#fca5a5;font-size:.85rem;cursor:pointer;background:transparent;transition:all .2s}
    .btn-logout:hover{background:rgba(239,68,68,.15)}
    .container{max-width:640px;margin:0 auto;padding:24px 16px}
    .section-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:24px;margin-bottom:20px}
    .section-title{font-size:1rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px;color:#a78bfa}
    .avatar-wrapper{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:16px}
    .avatar-preview{width:90px;height:90px;border-radius:50%;object-fit:cover;border:3px solid #a78bfa;background:#302b63}
    .avatar-placeholder{width:90px;height:90px;border-radius:50%;background:linear-gradient(135deg,#a78bfa,#818cf8);display:flex;align-items:center;justify-content:center;font-size:2.5rem;border:3px solid #a78bfa}
    label{display:block;font-size:.82rem;color:rgba(255,255,255,.65);margin-bottom:5px;font-weight:500}
    input[type=text],input[type=url],input[type=password]{width:100%;padding:11px 14px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;font-size:.95rem;margin-bottom:12px;outline:none;transition:border .2s}
    input:focus{border-color:#a78bfa}
    input::placeholder{color:rgba(255,255,255,.3)}
    .btn-save{padding:10px 24px;background:linear-gradient(135deg,#a78bfa,#818cf8);border:none;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;font-size:.9rem;transition:all .2s}
    .btn-save:hover{opacity:.85}
    .url-preview-box{background:rgba(0,0,0,.25);border:1px solid rgba(167,139,250,.3);border-radius:12px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:0}
    .url-preview-text{font-size:.9rem;color:#a78bfa;word-break:break-all}
    .btn-copy{padding:6px 14px;background:rgba(167,139,250,.2);border:1px solid #a78bfa;border-radius:8px;color:#a78bfa;font-size:.8rem;cursor:pointer;white-space:nowrap;font-weight:600;transition:all .2s}
    .btn-copy:hover{background:#a78bfa;color:#fff}
    .links-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px}
    .link-item{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px;display:flex;align-items:center;gap:10px}
    .link-item-info{flex:1;min-width:0}
    .link-item-title{font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .link-item-url{font-size:.78rem;color:rgba(255,255,255,.45);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .btn-del{padding:5px 10px;border:1px solid rgba(239,68,68,.3);border-radius:7px;color:#fca5a5;background:transparent;cursor:pointer;font-size:.8rem;transition:all .2s;flex-shrink:0}
    .btn-del:hover{background:rgba(239,68,68,.15)}
    .add-link-row{display:flex;gap:8px;flex-wrap:wrap}
    .add-link-row input{flex:1;min-width:120px;margin-bottom:0}
    .btn-add{padding:11px 20px;background:rgba(167,139,250,.2);border:1px solid #a78bfa;border-radius:10px;color:#a78bfa;font-weight:700;cursor:pointer;font-size:.9rem;white-space:nowrap;transition:all .2s}
    .btn-add:hover{background:#a78bfa;color:#fff}
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(30,30,60,.95);border:1px solid rgba(167,139,250,.4);border-radius:12px;padding:12px 24px;font-size:.9rem;color:#fff;z-index:999;display:none;backdrop-filter:blur(8px)}
    .btn-view{padding:10px 24px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;font-weight:600;cursor:pointer;font-size:.9rem;transition:all .2s;text-decoration:none;display:inline-block}
    .btn-view:hover{background:rgba(255,255,255,.12)}
    .save-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}
  </style>
</head>
<body>
<nav>
  <div class="logo">üîó Biojos</div>
  <div class="nav-right">
    <span class="nav-user" id="nav-username">...</span>
    <button class="btn-logout" onclick="logout()">Logout</button>
  </div>
</nav>

<div class="container">

  <!-- Profil -->
  <div class="section-card">
    <div class="section-title">üë§ Profil Saya</div>
    <div class="avatar-wrapper">
      <div id="avatar-display" class="avatar-placeholder">?</div>
    </div>
    <label>URL Gambar Avatar</label>
    <input type="url" id="avatar_url" placeholder="https://i.imgur.com/foto.jpg"/>
    <label>Username (URL Bio)</label>
    <input type="text" id="username" placeholder="username"/>
    <label>Nama Link Bio (Ditampilkan di halaman)</label>
    <input type="text" id="display_name" placeholder="Nama kamu"/>
    <div class="save-row">
      <button class="btn-save" onclick="saveProfile()">Simpan Profil</button>
      <a id="btn-view-profile" href="#" target="_blank" class="btn-view">üîó Lihat Bio</a>
    </div>
  </div>

  <!-- URL Preview -->
  <div class="section-card">
    <div class="section-title">üîó URL Bio Kamu</div>
    <div class="url-preview-box">
      <span class="url-preview-text" id="url-preview">-</span>
      <button class="btn-copy" onclick="copyURL()">Copy</button>
    </div>
  </div>

  <!-- Links -->
  <div class="section-card">
    <div class="section-title">üìã Daftar Link</div>
    <div class="links-list" id="links-list">
      <p style="color:rgba(255,255,255,.4);font-size:.9rem;text-align:center">Memuat link...</p>
    </div>
    <div style="margin-top:4px">
      <label>Tambah Link Baru</label>
      <div class="add-link-row">
        <input type="text" id="new-title" placeholder="Judul Link (mis: Instagram)"/>
        <input type="url" id="new-url" placeholder="https://..."/>
        <button class="btn-add" onclick="addLink()">+ Tambah</button>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
const API = '';
let TOKEN = localStorage.getItem('biojos_token');
let currentUser = null;

if (!TOKEN) window.location.href = '/login.html';

function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', duration);
}

async function apiFetch(path, opts = {}) {
  const res = await fetch(API + path, {
    ...opts,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + TOKEN,
      ...(opts.headers || {})
    }
  });
  if (res.status === 401) { logout(); return null; }
  return res;
}

async function loadProfile() {
  const res = await apiFetch('/api/user');
  if (!res) return;
  const user = await res.json();
  currentUser = user;
  document.getElementById('nav-username').textContent = '@' + user.username;
  document.getElementById('username').value = user.username || '';
  document.getElementById('display_name').value = user.display_name || '';
  document.getElementById('avatar_url').value = user.avatar_url || '';
  updateAvatarPreview(user.avatar_url, user.display_name || user.username);
  updateURLPreview(user.username);
}

function updateAvatarPreview(url, name) {
  const el = document.getElementById('avatar-display');
  if (url) {
    el.outerHTML = `<img src="${url}" class="avatar-preview" id="avatar-display" onerror="this.outerHTML='<div class=\\'avatar-placeholder\\' id=\\'avatar-display\\'>${(name||'?').charAt(0).toUpperCase()}</div>'"/>`;
  } else {
    el.className = 'avatar-placeholder';
    el.textContent = (name || '?').charAt(0).toUpperCase();
  }
}

function updateURLPreview(username) {
  const base = window.location.origin;
  const url = username ? `${base}/${username}` : '-';
  document.getElementById('url-preview').textContent = url;
  const viewBtn = document.getElementById('btn-view-profile');
  if (username) { viewBtn.href = `/${username}`; viewBtn.style.opacity = '1'; }
  else { viewBtn.href = '#'; viewBtn.style.opacity = '.4'; }
}

document.getElementById('avatar_url').addEventListener('input', function() {
  const nameEl = document.getElementById('display_name');
  updateAvatarPreview(this.value, nameEl.value);
});

document.getElementById('username').addEventListener('input', function() {
  updateURLPreview(this.value.trim());
});

async function saveProfile() {
  const display_name = document.getElementById('display_name').value.trim();
  const avatar_url = document.getElementById('avatar_url').value.trim();
  const username = document.getElementById('username').value.trim();
  if (!username) { showToast('‚ö†Ô∏è Username tidak boleh kosong'); return; }
  const res = await apiFetch('/api/user', {
    method: 'PUT',
    body: JSON.stringify({ display_name, avatar_url, username })
  });
  if (res && res.ok) {
    showToast('‚úÖ Profil berhasil disimpan!');
    updateAvatarPreview(avatar_url, display_name || username);
    updateURLPreview(username);
    document.getElementById('nav-username').textContent = '@' + username;
    const stored = JSON.parse(localStorage.getItem('biojos_user') || '{}');
    localStorage.setItem('biojos_user', JSON.stringify({...stored, username, display_name, avatar_url}));
  } else {
    showToast('‚ùå Gagal menyimpan profil');
  }
}

async function loadLinks() {
  const res = await apiFetch('/api/links');
  if (!res) return;
  const links = await res.json();
  const list = document.getElementById('links-list');
  if (!links.length) {
    list.innerHTML = '<p style="color:rgba(255,255,255,.4);font-size:.9rem;text-align:center">Belum ada link. Tambahkan link pertamamu! üîó</p>';
    return;
  }
  list.innerHTML = links.map(l => `
    <div class="link-item" data-id="${l.id}">
      <div class="link-item-info">
        <div class="link-item-title">${l.title}</div>
        <div class="link-item-url">${l.url}</div>
      </div>
      <button class="btn-del" onclick="deleteLink(${l.id})">Hapus</button>
    </div>`).join('');
}

async function addLink() {
  const title = document.getElementById('new-title').value.trim();
  const url = document.getElementById('new-url').value.trim();
  if (!title || !url) { showToast('‚ö†Ô∏è Judul dan URL wajib diisi'); return; }
  if (!url.startsWith('http')) { showToast('‚ö†Ô∏è URL harus diawali http:// atau https://'); return; }
  const res = await apiFetch('/api/links', {
    method: 'POST',
    body: JSON.stringify({ title, url })
  });
  if (res && res.ok) {
    document.getElementById('new-title').value = '';
    document.getElementById('new-url').value = '';
    showToast('‚úÖ Link berhasil ditambahkan!');
    loadLinks();
  } else {
    showToast('‚ùå Gagal menambah link');
  }
}

async function deleteLink(id) {
  if (!confirm('Hapus link ini?')) return;
  const res = await apiFetch('/api/links', {
    method: 'DELETE',
    body: JSON.stringify({ id })
  });
  if (res && res.ok) { showToast('üóëÔ∏è Link dihapus'); loadLinks(); }
}

function copyURL() {
  const text = document.getElementById('url-preview').textContent;
  if (text === '-') return;
  navigator.clipboard.writeText(text).then(() => showToast('‚úÖ URL berhasil dicopy!'));
}

function logout() {
  localStorage.removeItem('biojos_token');
  localStorage.removeItem('biojos_user');
  window.location.href = '/login.html';
}

loadProfile();
loadLinks();
</script>
</body>
</html>
